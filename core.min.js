!function(){let e,t=null,n=null,r=null,o=null,a=null,i=null,l=null,s=null,c=null,d=null,u={phi:Math.PI/4,theta:Math.PI/4,distance:5,target:[0,0,0],up:[0,1,0],pan:[0,0,0]},m=null,f=null,g=!1,p=!1,E=null,h=null,y=null,I=null;const v=function(){return new Float32Array(16)},A=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},_=function(e,t,n){let r=t[0],o=t[1],a=t[2],i=t[3],l=t[4],s=t[5],c=t[6],d=t[7],u=t[8],m=t[9],f=t[10],g=t[11],p=t[12],E=t[13],h=t[14],y=t[15],I=n[0],v=n[1],A=n[2],_=n[3];return e[0]=I*r+v*l+A*u+_*p,e[1]=I*o+v*s+A*m+_*E,e[2]=I*a+v*c+A*f+_*h,e[3]=I*i+v*d+A*g+_*y,I=n[4],v=n[5],A=n[6],_=n[7],e[4]=I*r+v*l+A*u+_*p,e[5]=I*o+v*s+A*m+_*E,e[6]=I*a+v*c+A*f+_*h,e[7]=I*i+v*d+A*g+_*y,I=n[8],v=n[9],A=n[10],_=n[11],e[8]=I*r+v*l+A*u+_*p,e[9]=I*o+v*s+A*m+_*E,e[10]=I*a+v*c+A*f+_*h,e[11]=I*i+v*d+A*g+_*y,I=n[12],v=n[13],A=n[14],_=n[15],e[12]=I*r+v*l+A*u+_*p,e[13]=I*o+v*s+A*m+_*E,e[14]=I*a+v*c+A*f+_*h,e[15]=I*i+v*d+A*g+_*y,e},L=function(e,t,n,r,o){const a=1/Math.tan(t/2);return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(o+r)/(r-o),e[11]=-1,e[12]=0,e[13]=0,e[14]=2*o*r/(r-o),e[15]=0,e},B=function(e,t,n,r){let o,a,i,l,s,c,d,u,m,f,g=t[0],p=t[1],E=t[2],h=r[0],y=r[1],I=r[2];return d=g-n[0],u=p-n[1],m=E-n[2],f=1/Math.sqrt(d*d+u*u+m*m),d*=f,u*=f,m*=f,o=y*m-I*u,a=I*d-h*m,i=h*u-y*d,f=Math.sqrt(o*o+a*a+i*i),f?(f=1/f,o*=f,a*=f,i*=f):(o=0,a=0,i=0),l=u*i-m*a,s=m*o-d*i,c=d*a-u*o,f=Math.sqrt(l*l+s*s+c*c),f?(f=1/f,l*=f,s*=f,c*=f):(l=0,s=0,c=0),e[0]=o,e[1]=l,e[2]=d,e[3]=0,e[4]=a,e[5]=s,e[6]=u,e[7]=0,e[8]=i,e[9]=c,e[10]=m,e[11]=0,e[12]=-(o*g+a*p+i*E),e[13]=-(l*g+s*p+c*E),e[14]=-(d*g+u*p+m*E),e[15]=1,e};function x(e){if(t=e.getContext("webgl2"),!t)return alert("无法初始化WebGL2。您的浏览器可能不支持它。"),!1;const r=R(t,t.VERTEX_SHADER,"#version 300 es\n        in vec3 a_position;\n        in vec3 a_color;      \n        uniform mat4 u_mvpMatrix;     \n        out float v_depth;        \n        out vec3 v_color;        \n        void main(void) {\n            gl_Position = u_mvpMatrix * vec4(a_position, 1.0);\n            v_depth = (gl_Position.z / gl_Position.w) * 0.5 + 0.5; \n            v_color = a_color;\n        }"),o=R(t,t.FRAGMENT_SHADER,"#version 300 es\n        precision mediump float; \n        uniform bool u_isDrawingLines; \n        uniform bool u_hasVertexColors; \n        in float v_depth;   \n        in vec3 v_color;        \n        out vec4 outColor;\n        void main(void) {\n            if (u_isDrawingLines) {\n                outColor = vec4(0.1, 0.1, 0.1, 1.0); \n            } else {\n                if (u_hasVertexColors) {\n                    outColor = vec4(v_color, 1.0); \n                } else {\n                    outColor = vec4(0.5 + v_depth * 0.3, 0.5 + v_depth * 0.3, 0.6 + v_depth * 0.4, 1.0); \n                }\n            }\n        }");return n=function(e,t,n){const r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))return console.error("Program linking error:",e.getProgramInfoLog(r)),e.deleteProgram(r),null;return r}(t,r,o),i=t.getUniformLocation(n,"u_mvpMatrix"),l=t.getUniformLocation(n,"u_isDrawingLines"),s=t.getUniformLocation(n,"u_hasVertexColors"),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.POLYGON_OFFSET_FILL),e.addEventListener("mousedown",T),e.addEventListener("mouseup",M),e.addEventListener("mousemove",b),e.addEventListener("wheel",F),e.addEventListener("contextmenu",e=>e.preventDefault()),!0}function T(e){g=!0,2===e.button&&(p=!0),m=e.clientX,f=e.clientY}function M(e){g=!1,2===e.button&&(p=!1)}function b(e){if(!g)return;const t=e.clientX-m,n=e.clientY-f;if(m=e.clientX,f=e.clientY,p||e.ctrlKey||e.metaKey){const e=v(),r=[u.target[0]+u.distance*Math.sin(u.phi)*Math.sin(u.theta),u.target[1]+u.distance*Math.cos(u.phi),u.target[2]+u.distance*Math.sin(u.phi)*Math.cos(u.theta)];B(e,r,u.target,u.up);const o=[e[0],e[4],e[8]],a=[e[1],e[5],e[9]],i=.002*u.distance;u.pan[0]-=o[0]*t*i+a[0]*n*i,u.pan[1]-=o[1]*t*i+a[1]*n*i,u.pan[2]-=o[2]*t*i+a[2]*n*i}else u.theta-=.005*t,u.phi-=.005*n,u.phi=Math.max(.01,Math.min(Math.PI-.01,u.phi))}function F(e){e.preventDefault(),u.distance*=e.deltaY>0?1.1:.9,u.distance=Math.max(.1,u.distance)}function R(e,t,n){const r=e.createShader(t);return e.shaderSource(r,n),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)?r:(console.error("Shader compilation error:",e.getShaderInfoLog(r)),e.deleteShader(r),null)}function C(){if(!(t&&n&&a&&a.triangleInfo&&0!==a.triangleInfo.numIndices))return;t.clearColor(.92,.92,.92,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.useProgram(n);const e=v();L(e,45*Math.PI/180,t.canvas.clientWidth/t.canvas.clientHeight,.1,100);const d=v(),m=u.target[0]+u.pan[0]+u.distance*Math.sin(u.phi)*Math.sin(u.theta),f=u.target[1]+u.pan[1]+u.distance*Math.cos(u.phi),g=u.target[2]+u.pan[2]+u.distance*Math.sin(u.phi)*Math.cos(u.theta),p=[u.target[0]+u.pan[0],u.target[1]+u.pan[1],u.target[2]+u.pan[2]];B(d,[m,f,g],p,u.up);const E=v();A(E);const h=v();_(h,e,d),_(h,h,E),t.uniformMatrix4fv(i,!1,h),t.uniform1i(s,c.hasColors?1:0),t.uniform1i(l,0),t.polygonOffset(1,1),t.bindVertexArray(r),t.drawElements(t.TRIANGLES,a.triangleInfo.numIndices,a.triangleInfo.indexType,0),a.lineInfo&&a.lineInfo.numIndices>0&&(t.uniform1i(l,1),t.bindVertexArray(o),t.drawElements(t.LINES,a.lineInfo.numIndices,a.lineInfo.indexType,0)),t.bindVertexArray(null)}function P(){a&&a.triangleInfo&&a.triangleInfo.numIndices>0&&C(),d=requestAnimationFrame(P)}async function S(t,n){const r=2097152;let o=0;const a=document.getElementById("fileProgressContainer"),i=n+"-progress";let l=document.getElementById(i);for(l||(l=document.createElement("div"),l.id=i,l.classList.add("file-progress"),a.appendChild(l)),l.textContent="开始读取 "+t.name+"...",e.postMessage({type:"start",fileType:n});o<t.size;){const a=t.slice(o,o+r),i=await a.arrayBuffer(),s=o+r>=t.size;e.postMessage({type:"fileChunk",fileType:n,chunkData:i,isLastChunk:s},[i]),o+=r;const c=Math.min(100,Math.round(o/t.size*100));l.textContent="正在传输 "+t.name+": "+c+"%"}l.textContent=t.name+" 传输完成。"}async function D(){const t=document.getElementById("mshFileInput").files[0],n=document.getElementById("resFileInput").files[0],r=document.getElementById("mshInputTextArea").value,o=document.getElementById("loadingIndicator");document.getElementById("fileProgressContainer").innerHTML="",o.style.display="block",document.getElementById("legendContainer").style.display="none",d&&(cancelAnimationFrame(d),d=null),E=t||null,h=n||null;let a=E||(r.trim()?r:null);if(!a)return alert("请选择MSH文件或在文本框中粘贴内容。"),void(o.style.display="none");let i=Promise.resolve(),l=null;a instanceof File?i=S(a,"msh"):"string"==typeof a&&(l=a);let s=Promise.resolve();h instanceof File&&(s=S(h,"res"));try{await Promise.all([i,s]),e.postMessage({type:"processAllData",mshFromTextarea:l})}catch(e){o.style.display="none",alert(e.message),console.error(e)}}function N(e){const t=document.getElementById("fieldSelector"),n=t.value;t.innerHTML="";const r=document.createElement("option");r.value="default",r.textContent="默认着色 (深度)",t.appendChild(r),e&&e.length>0&&e.forEach(e=>{if("default"===e.internalName)return;const n=document.createElement("option");n.value=e.internalName,n.textContent=e.displayName,t.appendChild(n)}),Array.from(t.options).some(e=>e.value===n)?t.value=n:t.value="default"}function U(t){const n=document.getElementById("loadingIndicator");y&&(n.style.display="block",e.postMessage({type:"prepareRender",mshBaseGeo:y,resDataContainer:I,field:t}))}window.onload=()=>{const i=document.getElementById("glCanvas"),l=document.getElementById("loadingIndicator");if(!x(i))return void console.error("WebGL在页面加载时初始化失败。");try{const t=document.getElementById("dataProcessorWorker").textContent,n=new Blob([t],{type:"application/javascript"}),r=URL.createObjectURL(n);e=new Worker(r),URL.revokeObjectURL(r)}catch(e){return console.error("创建 Worker 失败:",e),void alert("无法创建后台处理线程。您的浏览器可能不支持或存在安全限制。")}e.onmessage=function(e){const{type:i,mshBaseGeo:s,resData:u,renderData:m,error:f}=e.data;if(l.style.display="none",f)return alert("Worker处理错误: "+f),void console.error("Full error string from worker:",f);if("initialDataReady"===i)y=s,I=u,N(u?u.availableScalarFields:[]),U(document.getElementById("fieldSelector").value);else if("renderDataReady"===i){if(c=m,c.hasColors?(document.getElementById("legendMin").textContent="低 ("+c.minScalar.toExponential(2)+")",document.getElementById("legendMax").textContent="高 ("+c.maxScalar.toExponential(2)+")",document.getElementById("legendContainer").style.display="block"):document.getElementById("legendContainer").style.display="none",a=function(){if(!t||!c||0===c.vertices.length)return null;r&&t.deleteVertexArray(r),r=t.createVertexArray(),t.bindVertexArray(r);const e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,c.vertices,t.STATIC_DRAW);const a=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bufferData(t.ELEMENT_ARRAY_BUFFER,c.indices,t.STATIC_DRAW);const i=t.getAttribLocation(n,"a_position"),l=t.getAttribLocation(n,"a_color"),s=6*Float32Array.BYTES_PER_ELEMENT;t.vertexAttribPointer(i,3,t.FLOAT,!1,s,0),t.enableVertexAttribArray(i),t.vertexAttribPointer(l,3,t.FLOAT,!1,s,3*Float32Array.BYTES_PER_ELEMENT),t.enableVertexAttribArray(l),o&&t.deleteVertexArray(o),o=t.createVertexArray(),t.bindVertexArray(o),t.bindBuffer(t.ARRAY_BUFFER,e);const d=t.createBuffer();return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,d),t.bufferData(t.ELEMENT_ARRAY_BUFFER,c.lineIndices,t.STATIC_DRAW),t.vertexAttribPointer(i,3,t.FLOAT,!1,s,0),t.enableVertexAttribArray(i),t.vertexAttribPointer(l,3,t.FLOAT,!1,s,3*Float32Array.BYTES_PER_ELEMENT),t.enableVertexAttribArray(l),t.bindVertexArray(null),{triangleInfo:{numIndices:c.indices.length,indexType:t.UNSIGNED_INT},lineInfo:{numIndices:c.lineIndices.length,indexType:t.UNSIGNED_INT}}}(),!a||!a.triangleInfo||0===a.triangleInfo.numIndices)return void alert("未能为渲染设置缓冲区。");d?C():P()}},e.onerror=function(e){l.style.display="none",console.error("Web Worker 错误对象:",e),alert("处理数据时发生后台错误: "+e.message)};const s=document.getElementById("mshFileInput"),u=(document.getElementById("mshInputTextArea"),document.getElementById("resFileInput")),m=document.getElementById("fieldSelector");document.getElementById("loadProcessButton").addEventListener("click",D),s.addEventListener("change",function(e){E=e.target.files[0]||null}),u.addEventListener("change",function(e){h=e.target.files[0]||null,h||N([])}),m.addEventListener("change",function(){U(this.value)})}}();